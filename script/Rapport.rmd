---
output: html_document
runtime: shiny
---
<!-- # --- -->
<!-- # title: "Le logement social en France" -->
<!-- # runtime: shiny -->
<!-- # output: html_document -->
<!-- # author: "Eric Guilmin & Maxime Chauveau" -->
<!-- # date: "16/05/2019" -->
<!-- # jury: "A.Deschamps & M.Theuliere" -->
<!-- # responsable pédagogique : "Xavier Aimé" -->
<!-- # etablissement : "Cnam - Pays de la Loire - Nantes" -->
<!-- # formation : "Master Mégadonnées et Analyse Sociale" -->
<!-- # --- -->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
suppressPackageStartupMessages(suppressWarnings(library(data.table)))
suppressPackageStartupMessages(suppressWarnings(library(DT)))
suppressPackageStartupMessages(suppressWarnings(library(plotly)))
suppressPackageStartupMessages(suppressWarnings(library(leaflet)))
suppressPackageStartupMessages(suppressWarnings(library(raster)))
suppressPackageStartupMessages(suppressWarnings(library(shiny)))
suppressPackageStartupMessages(suppressWarnings(library(sqldf)))
suppressPackageStartupMessages(suppressWarnings(library(proto)))
suppressPackageStartupMessages(suppressWarnings(library(gsubfn)))
suppressPackageStartupMessages(suppressWarnings(library(RSQLite)))
suppressPackageStartupMessages(suppressWarnings(library(questionr)))
suppressPackageStartupMessages(suppressWarnings(library(ggplot2)))
suppressPackageStartupMessages(suppressWarnings(library(plyr)))
suppressPackageStartupMessages(suppressWarnings(library(dplyr)))
suppressPackageStartupMessages(suppressWarnings(library(ggrepel)))
suppressPackageStartupMessages(suppressWarnings(library(scales)))
```

```{r dataload }
## Chargement de la table de données clean
setwd("C:/Users/mchauveau/Documents/Master MEDAS/Datavisualisation/Test_RMD/Test_rmd")
load(file="./data/ville.Rdata")
load("./data/dataGPS.RData")
dataPDLL2016 <- read.csv2("./data/rpls2016_detail_pays_de_la_loire.csv", encoding = "latin1")
dataPDLL2017 <- read.csv2("./data/RPLS2017_geoloc_detail_reg52.csv", encoding = "latin1")
dataPDLL2018 <- read.csv2("./data/RPLS2018_detail_reg52.csv", encoding = "latin1")
load(file="./data/densite.Rdata")
```

<div>
<img src="https://pbs.twimg.com/profile_images/875730063773368322/GHFjX6Bl.jpg" width=10%  align="left" />

<img src="https://aquitem.surleblog.fr/wp-content/uploads/2016/10/Dataviz-dashboard-ecommerce-marketing-data-bigdata-1-650x340.png" width=20% align="right" />
</div>
<br /><br />
\n<br />
\n<br />
\n<br />
\n<br />
\n<br />
\n
\n


<center> <h1>Le logement social en France</h1> </center>


<center>**Groupe :** Éric Guilmin & Maxime Chauveau </center>



<center>**Jury :** A.Deschamps & M.Theuliere </center>

<center>**Responsable Pédagogique :**  </center>



<center>**Établissement :** Cnam - Pays de la Loire - Nantes </center>

<center>**Formation :** Master Mégadonnées et Analyse Sociale </center>

<!-- <center> <h1>Sommaire</h1> </center> -->






<center> <h1>Présentation du sujet</h1> </center>


  L'objectif de ce projet est de réaliser une enquête sur le logement social en France. Pour cela nous avons à notre disposition les bases des données de 2016, 2017 et 2018 des logements sociaux en France.

  Mais avant toute chose, faisons un état des lieux de ce que c’est qu’un logement social. C’est un logement dont la construction bénéficie de soutiens publics et il est destiné à loger des personnes à faibles ressources, ne pouvant le faire dans le parc privé. En France, ce type de logement est réglementé, tant au niveau de son financement, que de son attribution et de sa gestion par les organismes HLM. Chaque année, l’État détermine les niveaux de ressources et les niveaux de loyers en HLM. Au titre de la mixité sociale, les communes ont également des obligations de construction de logements sociaux, selon leur taille et le niveau de tension du marché locatif.
    
Maintenant que nous avons une vision plus claire du sujet, nous allons pouvoir faire une analyse du parc social français. Nous commencerons par une vue nationale, puis un focus sur la région des Pays de la Loire et enfin nous travaillerons sur les données de la ville de Nantes.


<h3>Description fonctionnelle</h3>

Afin de réaliser notre projet, nous avons dû user d’ingéniosité pour résoudre certaines problématiques. Nous pensons surtout au fait que nous n’avions pas toujours les coordonnées géographiques des logements sociaux. Pour se faire, nous nous sommes connectés à une API, https://adresse.data.gouv.fr/csv . En renseignant l’adresse (numéro, type de voie, nom de la voie, code postal, ville et le code INSEE) nous avons pu récupérer la longitude et la latitude de chacune de nos adresses. Cependant, nous étions limités d’un point de vue volumétrie, 6 Mo est la capacité maximale pour le traitement. Nous avons donc dû nous y reprendre à plusieurs fois.
	Autre problème à souligner, le temps de traitement. Nous nous sommes rendu compte que pour gagner en efficacité, il fallait séparer la partie traitement de données et la partie datavisualisation. D’où la présence de fichiers .Rdata, se sont nos données « propres », prêtes à la datavisualisation. Cela nous offre trois avantages :
- Le premier, nous avons besoin de lancer qu’une seule fois la phase de traitement de données qui peut s’avérer longue et gourmande en mémoire vive.
- Le second, c’est que les fichiers Rdata peuvent contenir plusieurs objets, donc là où il faut charger plusieurs fichiers, ici il n’y qu’un seul fichier à charger.
- Le troisième, les fichiers .Rdata sont natifs à R, ils sont donc plus rapide à charger.

Enfin, concernant le choix de nos outils de datavisualisation, nous avons essentiellement travaillé avec les packages « plotly » et « leaflet ». Nous avons choisi plotly car il nous permet de créer des graphiques web interactifs et leaflet pour ses cartes Web interactives.



<center> <h1>Présentation des résultats</h1> </center>


<center><h3>Tableau présentant le nombre de logements sociaux par communes</h3></center>
  

```{r tableau}
DT::renderDataTable(ville,
                    options = list(searching = TRUE, ordering = FALSE, paging= TRUE),
                    escape = FALSE,
                    rownames = FALSE,
                    colnames = c("Communes","D\u00e9partements","R\u00e9gions", "Nombre de logements sociaux"))
```

  
  Pour commencer nous avons créé un tableau permettant de visualiser le nombre de logements sociaux par commune. Ensuite nous nous sommes attardés sur la répartition des logements sociaux en fonction des régions.


```{r plotRegions,fig.width=10}

region=ville[,sum(N),by=LIBREG]
plot_ly(x=region$LIBREG,y=region$V1,type="bar",
        name="logements sociaux") %>%
  layout(yaxis=list(title="Nombre de logements sociaux"),
         title="Diagramme à barres représentant les régions françaises\nen fonction du nombre de logements sociaux")  %>%
  add_trace(y=mean(region$V1),mode="lines",type="scatter",name="moyenne nationale")



logville=ville[order(N,decreasing = FALSE),]
logville=tail(logville,10)
logville$LIBCOM[2]="le havre"
yform = list(categoryorder = "array",categoryarray = logville$LIBCOM)
p1=plot_ly(x=logville$N,y=logville$LIBCOM,type="bar", marker = list(color = 'rgb(198, 111, 167)',
                                                                   line = list(color = 'rgb(8,48,107)',
                                                                               width = 3)),
                                                     orientation="h",name="logements sociaux") %>%
layout(yaxis=yform)
```


Nous pouvons observer que la région avec le plus de logements sociaux est celle d'Ile de France, celle avec le moins est la Corse. Les régions Auverge Rhone Alpes, Ile de France, Grand-Est et Haut de France ont un nombre de logements sociaux supérieur à la moyenne nationale.


```{r plotRegions1,fig.width=10}

logville=logville[order(N)]

yform = list(categoryorder = "array",categoryarray = logville$LIBCOM)

#Création du graph
p2=plot_ly(data = logville,
           x=~N,
           y=~LIBCOM,
           type="bar",
           marker = list(color = 'rgb(229, 194, 216)',                                                                   line = list(color = 'rgb(8,48,107)',
                                                                                                                                     width = 3)),
           orientation="h",
           name="Population") %>%
  layout(yaxis=yform,
         title="Top 10 des villes françaises en terme de logement sociaux")

p2
```


Le  diagrame ci-dessus nous montre les villes françaises avec le plus grand nombre de logement sociaux. Nous remarquons que c'est la ville Paris qui a le plus de logements sociaux. Cela semble logique vue que Paris est la plus grande ville de France avec ses 2,141 millions d’habitants. C’est pourquoi, nous allons comparer ses données en prenant en compte la taille de la population de ses villes. 


```{r plotRegions2,fig.width=10}
# subplot(p1,p2)

pop=densite[Ville %in% logville$LIBCOM,]

logville=logville[order(LIBCOM)]
pop=pop[order(Ville)]

perVille=data.table(per=logville$N/pop$Population,ville=pop$Ville)
perVille=perVille[order(per),]

yform = list(categoryorder = "array",categoryarray = perVille$ville)

plot_ly(x=perVille$per,
        y=perVille$ville,
        type="bar",
        orientation="h",
        marker = list(color = 'rgb(117, 158, 179 )',
                      line = list(color = 'rgb(8,48,107)',
                                  width = 3)))%>%
  layout(yaxis=yform,
         title="Top 10 des villes françaises en fonction du rapport Nb_logement/Habitant")
```


Nous pouvons donc constater que Paris n'est plus la première ville mais la 9ème. Et c'est Reims qui se voit octroyer la première place, elle est donc la ville avec le plus de logements sociaux par habitants.


<center><h3>Carte de la France représentant le nombre de logements sociaux par régions</h3></center>


```{r visuRegions,fig.width=10}
region2=region[-14,]
region2=region2[order(LIBREG),]


qpal=colorQuantile("Oranges",
                   region2$V1,
                   n = 6)

adm = getData('GADM',
              country='FRA',
              level=1)

labels <- sprintf("<strong>%s</strong><br/>%g logements",
                  region2$LIBREG,
                  region2$V1) %>%
  lapply(htmltools::HTML)



leaflet() %>%
  addTiles() %>%
  addPolygons(data=adm, 
              fillColor = ~qpal(region2$V1),
              weight = 2,
              opacity = 1,
              color = "white",
              dashArray = "3",
              fillOpacity = 0.7,
              highlight = highlightOptions(weight = 5,
                                           color = "#666",
                                           dashArray = "",
                                           fillOpacity = 0.7,
                                           bringToFront = TRUE),
              label = labels,
              labelOptions = labelOptions(style = list("font-weight" = "normal",
                                                       padding = "3px 8px"),
                                          textsize = "15px",
                                          direction = "auto")
              )
```


La carte de France montre la densité de logements sociaux par région. Ce graphique nous donne les mêmes informations mais avec une visualisation un peu plus ludique. Plus la couleur de la région est proche du rouge plus il y a de logements. Les mêmes conclusions sont observées que précédement.


<center><h3>Répartition des logements sociaux par départements</h3></center>


```{r plotDep,fig.width=10}

#Barre de sélection
inputPanel(selectInput("reg",
                       "R\u00e9gions",
                       choices = unique(ville$LIBREG),
                       selected = "Auvergne-Rh"
                       )
           )

#Graph Nb logement / département
renderPlotly({
  regSelect=ville[LIBREG %in% input$reg,]
  resumeRegion=regSelect[,sum(N),by=LIBDEP]
    plot_ly(x=resumeRegion$LIBDEP,
            y=resumeRegion$V1,
            type="bar",
            name="logements sociaux",
            marker = list(color = 'rgb(124, 180, 211)',
                          line = list(color = 'rgb(8,48,107)',
                                      width = 3
                                      )
                          ),
            ) %>%
      layout(yaxis=list(title="Nombre de logements sociaux")) %>%
      add_trace(y=mean(resumeRegion$N),
                mode="lines",
                type="scatter",
                name="moyenne r\u00e9gionale"
                )
    })

#Graph Top 10 ville
renderPlotly({
  regSelect=ville[LIBREG %in% input$reg,]
  logville=regSelect[,sum(N),by=LIBCOM]
  logville=logville[order(V1,decreasing = FALSE),]
  logville=tail(logville,10)
  yform = list(categoryorder = "array",
               categoryarray = logville$LIBCOM
               )
  plot_ly(x=logville$V1,
          y=logville$LIBCOM,
          type="bar",
          orientation="h",
          name="logements sociaux",
          marker = list(color = 'rgb(128, 170, 174 )',
                        line = list(color = 'rgb(8,48,107)',
                                    width = 3
                                    )
                        )
          ) %>%
    layout(yaxis=yform)
  })
```


Le premier barplot montre le nombre de logements sociaux par département de la région sélectionnée. Le second donne les dix villes avec le plus de logements sociaux et par ordre décroissant de la région choisie. 

Par exemple, pour la région "Auvergne Rhone Alpes", c'est le rhone qui a le plus de logements et le cantal qui en a le moins. Dans cette région, c'est la ville de Lyon qui comprend le plus de logement.


<center><h3>Analyse des Pays de la Loire</h3></center>


Intéresserons-nous maintenant à la région des Pays de la Loire en essayant d’en apprendre plus sur les caractéristiques du parc social ligérien. Nous commencerons par les types de constructions des logements sociaux.


```{r Donut_Char,fig.width=10}
knitr::opts_chunk$set(echo = FALSE, message = FALSE,warning = FALSE)
# package pour la fonction arrange
#install.packages("dplyr")
#library(dplyr)


# package pour la fonction geom_label_repel
#install.packages("ggrepel")
#library(ggrepel)

#install.packages("scales")
library(scales)

#dataframe de la freq des types de construction -->
df_typeCons <- as.data.frame(table(dataPDLL2016$TYPECONST_red))

# Renommage colonne
colnames(df_typeCons) <- c("Type_Construction", "freq")

#Modification des valeurs Type_Construction pour une meilleure compréhension

df_typeCons$Type_Construction <- as.character(df_typeCons$Type_Construction)
df_typeCons$Type_Construction[df_typeCons$Type_Construction == "C"] <- "Collectif"

df_typeCons$Type_Construction[df_typeCons$Type_Construction == "I"] <- "Individuel"

df_typeCons$Type_Construction[df_typeCons$Type_Construction == "E"] <- "Etudiant"

#trier le dataframe dans l'ordre croissant

SQL_OrderBy <- "SELECT * FROM df_typeCons ORDER BY freq"

df_typeCons <- sqldf(SQL_OrderBy)

#mutate permet d'ajouter une colonne

df_typeCons <- mutate(df_typeCons, Pourcentage=percent(`freq`/sum(`freq`)))

# Création du Donut

Donut_Char <- df_typeCons %>%
  plot_ly(labels = ~Type_Construction, values = ~freq) %>%
  add_pie(hole = 0.6) %>%
  layout(title = "Répartition des types de constructions des logements sociaux\ndans les Pays de la Loire en 2016",  showlegend = T,
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

Donut_Char
```


Nous pouvons constater qu’en 2016, la répartition du type de construction des logements sociaux dans les Pays de la Loire se faisait ainsi : près des ¾ des logements sociaux (72%) sont collectifs, 27% sont des logements individuels et le reste, moins de 1%, sont destinés aux étudiants. La quasi-totalité des logements pour les étudiants est gérée par le CROUS (Centre Régional des Œuvres Universitaires et Scolaires).

Nous poursuivrons notre étude sur le nombre de pièces que peuvent avoir les logements sociaux.


```{r plot2,fig.width=10}
knitr::opts_chunk$set(echo = FALSE, message = FALSE,warning = FALSE)

table_NbPiece <- table(dataPDLL2016$NBPIECE_red)
table_NbPiece <- as.data.frame(table_NbPiece)

# Renommage colonne
colnames(table_NbPiece) <- c("NbPiece", "freq")

#Ajout de la colonne Pourcentage 
table_NbPiece <- mutate(table_NbPiece, Pourcentage=percent(`freq`/sum(`freq`)))

#Calcul pour connaitre le nombre moyen de pièce dans le logement sociaux
Values_NbPiece <- as.numeric(as.character(table_NbPiece$NbPiece))
Values_NbPiece <- as.data.frame(Values_NbPiece)

#Fusion 2 Dataframe
table_NbPiece <- cbind(table_NbPiece,Values_NbPiece)

table_NbPiece <- mutate(table_NbPiece, Quoeficient=`freq`*`Values_NbPiece`)

moy_NbPiece <- sum(table_NbPiece$Quoeficient)/sum(table_NbPiece$freq)

#Création du diagramme

plot_ly(x=table_NbPiece$NbPiece,y=table_NbPiece$freq,type="bar",name="logements sociaux", marker = list(color = 'rgb(147, 192, 148)',
                                                                   line = list(color = 'rgb(8,48,107)',
                                                                               width = 3))) %>%
  layout(title = "Diagramme à barres représentant le nombre de\nlogements sociaux en fonction du nombre de pièce",
    yaxis=list(title="Nombre de logements sociaux"))
```


```{r Moy_NpPiece2017}
knitr::opts_chunk$set(echo = FALSE, message = FALSE,warning = FALSE)

table_NbPiece2017 <- table(dataPDLL2017$nbpiece_red)
table_NbPiece2017 <- as.data.frame(table_NbPiece2017)

# Renommage colonne
colnames(table_NbPiece2017) <- c("NbPiece", "freq")

#Ajout de la colonne Pourcentage 
table_NbPiece2017 <- mutate(table_NbPiece2017, Pourcentage=percent(`freq`/sum(`freq`)))

#Calcul pour connaitre le nombre moyen de pièce dans le logement sociaux
Values_NbPiece2017 <- as.numeric(as.character(table_NbPiece2017$NbPiece))
Values_NbPiece2017 <- as.data.frame(Values_NbPiece2017)

#Fusion 2 Dataframe
table_NbPiece2017 <- cbind(table_NbPiece2017,Values_NbPiece2017)

table_NbPiece2017 <- mutate(table_NbPiece2017, Quoeficient=`freq`*`Values_NbPiece2017`)

moy_NbPiece2017 <- sum(table_NbPiece2017$Quoeficient)/sum(table_NbPiece2017$freq)
moy_NbPiece2017
```


```{r Moy_NpPiece2018}
knitr::opts_chunk$set(echo = FALSE, message = FALSE,warning = FALSE)

table_NbPiece2018 <- table(dataPDLL2018$NBPIECE)
table_NbPiece2018 <- as.data.frame(table_NbPiece2018)

# Renommage colonne
colnames(table_NbPiece2018) <- c("NbPiece", "freq")

#Ajout de la colonne Pourcentage 
table_NbPiece2018 <- mutate(table_NbPiece2018, Pourcentage=percent(`freq`/sum(`freq`)))

#Calcul pour connaitre le nombre moyen de pièce dans le logement sociaux
Values_NbPiece2018 <- as.numeric(as.character(table_NbPiece2018$NbPiece))
Values_NbPiece2018 <- as.data.frame(Values_NbPiece2018)

#Fusion 2 Dataframe
table_NbPiece2018 <- cbind(table_NbPiece2018,Values_NbPiece2018)

table_NbPiece2018 <- mutate(table_NbPiece2018, Quoeficient=`freq`*`Values_NbPiece2018`)

moy_NbPiece2018 <- sum(table_NbPiece2018$Quoeficient)/sum(table_NbPiece2018$freq)
moy_NbPiece2018
```

  Lorsque nous observons ce diagramme, nous constatons que la distribution semble suivre la loi normale, nous remarquons même une asymétrie vers la droite. Les logements à 3 pièces sont les plus représentés (40%), viennent ensuite les logements avec 4 pièces (28%). En somme, la majorité des logements sociaux des Pays de la Loire en 2019 (81.5%) en 2016 comportent entre 2 et 4 pièces. Ce qui semble cohérent lorsque nous comparons ces chiffres avec la taille moyenne d’un foyer français en 2013 (2.2 personnes). https://www.insee.fr/fr/statistiques/1280856
  D'après l'INSEE, le nombre de personnes par ménage diminue, passant de 2.88 à 2.31 personnes entre 1975 et 2005. Il serait donc intéressant de voir si cela à un impact sur le nombre de pièces des logements sociaux. Même si cela reste difficilement comparable car ici nous travaillons uniquement sur les logements sociaux. En 2016, la moyenne du nombre de pièces par logement était de 3.13, en 2017 de 3.21 et en 2018 de 3.11. Les valeurs sont tellement proches les unes des autres que nous ne pouvons tirer de conclusion, même si nous observons une diminution entre 2016 et 2018.
  

<center><h3>Analyse de la commune de Nantes</h3></center>

Il était interessant d'observer les logements sociaux à l'échelle de la ville. Pour ce faire, nous avons choisi la ville de Nantes.  


```{r plot3,fig.width=10}
 
 knitr::opts_chunk$set(echo = FALSE, message = FALSE,warning = FALSE)
 
 # affichage carte
 
 nantesLong <- -1.5533600
 nantesLat <- 47.2172500
 
 points2016 <- unique(data.frame(longitudes = dfNantes2016$longitude,
                      latitudes = dfNantes2016$latitude,
                      annee = '2016',
                      DPE = dfNantes2016$DPEENERGIE_red)
                      )
 
 points2017 <- unique(data.frame(longitudes = dfNantes2017$longitude,
                                 latitudes = dfNantes2017$latitude,
                                 annee = '2017',
                                 DPE = dfNantes2017$DPEENERGIE_red
                                 )
                      )
 
 points2018 <- unique(data.frame(longitudes = dfNantes2018$longitude,
                                 latitudes = dfNantes2018$latitude,
                                 annee = '2018',
                                 DPE = dfNantes2018$DPEENERGIE
                                 )
                      )
```


```{r plot4,fig.width=10}
 
 knitr::opts_chunk$set(echo = FALSE, message = FALSE,warning = FALSE)

 colors <- c('rgb(239, 150, 207)', 'rgb(150, 211, 239)','rgb(150, 181, 239)' )
 
 #Annee 2016
 points2016$DPE[points2016$DPE == ''] <- NA
 points2016$DPEGrad[points2016$DPE %in% c('A','B')] <- 'Bien isolé'
 points2016$DPEGrad[points2016$DPE %in% c('C','D')] <- 'Moyennement isolé'
 points2016$DPEGrad[points2016$DPE %in% c('E','F','G')] <- 'Mal isolé'
 table_ener2016 <- table(points2016$DPEGrad)
 
 points2017$DPE[points2017$DPE == ''] <- NA
 points2017$DPEGrad[points2017$DPE %in% c('A','B')] <- 'Bien isolé'
 points2017$DPEGrad[points2017$DPE %in% c('C','D')] <- 'Moyennement isolé'
 points2017$DPEGrad[points2017$DPE %in% c('E','F','G')] <- 'Mal isolé'
 table_ener2017 <- table(points2017$DPEGrad)
 
 points2018$DPE[points2018$DPE == ''] <- NA
 points2018$DPEGrad[points2018$DPE %in% c('A','B')] <- 'Bien isolé'
 points2018$DPEGrad[points2018$DPE %in% c('C','D')] <- 'Moyennement isolé'
 points2018$DPEGrad[points2018$DPE %in% c('E','F','G')] <- 'Mal isolé'
 table_ener2018 <- table(points2018$DPEGrad)
```




<!-- # ```{r plot5,fig.width=10} -->
<!-- #   -->
<!-- #  knitr::opts_chunk$set(echo = FALSE, message = FALSE,warning = FALSE) -->
<!-- #   -->
<!-- # # #Annee 2017 -->
<!-- #  points2017$DPE[points2017$DPE == ''] <- NA -->
<!-- #  points2017$DPEGrad[points2017$DPE %in% c('A','B')] <- 'Bien isolé' -->
<!-- #  points2017$DPEGrad[points2017$DPE %in% c('C','D')] <- 'Moyennement isolé' -->
<!-- #  points2017$DPEGrad[points2017$DPE %in% c('E','F','G')] <- 'Mal isolé' -->
<!-- #  table_ener2017 <- table(points2017$DPEGrad) -->
<!-- #  p <- plot_ly(points2017, labels = names(table_ener2017), values = table_ener2017, type = 'pie', marker = list(colors = colors, line = list(color = 'rgb(8,48,107)', width = 3))) -->
<!-- #  p -->
<!-- #  ``` -->
<!-- #  -->
<!-- #  -->
<!-- # ```{r plot6,fig.width=10} -->
<!-- #   -->
<!-- #  knitr::opts_chunk$set(echo = FALSE, message = FALSE,warning = FALSE) -->
<!-- #   -->
<!-- #  #Annee 2018 -->
<!-- #  points2018$DPE[points2018$DPE == ''] <- NA -->
<!-- #  points2018$DPEGrad[points2018$DPE %in% c('A','B')] <- 'Bien isolé' -->
<!-- #  points2018$DPEGrad[points2018$DPE %in% c('C','D')] <- 'Moyennement isolé' -->
<!-- #  points2018$DPEGrad[points2018$DPE %in% c('E','F','G')] <- 'Mal isolé' -->
<!-- #  table_ener2018 <- table(points2018$DPEGrad) -->
<!-- #  p <- plot_ly(points2018, labels = names(table_ener2018), values = table_ener2018, type = 'pie', marker = list(colors = colors, line = list(color = 'rgb(8,48,107)', width = 3))) -->
<!-- #  p -->
<!-- # ``` -->


Le graphique ci-dessous, nous montre l'évolution du nombre de construction de nouveaux bâtiments de logements sociaux sur la ville de Nantes pour les années 2016, 2017 et 2018.
On observe une augmentation du nombre de construction puisque l'on passe de 1818 en 2016 à 4245 en 2018, soit une augmentation d'environ 133% en 2 ans. Cette augmentation peut s'expliquer par le fait que Nantes est en zone tendue, c’est-à-dire que l’offre de logement est insuffisante (difficultés d’accès au logement, niveaux élevés de loyers).  Il faut rajouter à cela que Nantes est très attractive, on observe une augmentation de la population de 1.3% par an depuis le début des années 2010. Le nombre de logement de sociaux devrait encore augmenter car en 2019, il y a 30.000 demandes en attente.


```{r plotNbConstruction,fig.width=10}
 
 knitr::opts_chunk$set(echo = FALSE, message = FALSE,warning = FALSE)
 
 points <- rbind(points2016, points2017, points2018)
 
 table_evo <- table(points$annee)
 p <- plot_ly(y=table_evo,
              x=names(table_evo),
              type='bar',
              marker = list(color = 'rgb(166, 182, 166)',                                                                   line = list(color = 'rgb(8,48,107)',                                                                        width = 3)))
 p
 
 evolution <- 100*(nrow(points2018)-nrow(points2016))/nrow(points2016)
```


Intéressons-nous maintenant à la répartition géographique des logements sociaux.
Même s'il arrive d'en retrouver de manière isolée, il apparait que sur la carte suivante, les logements sociaux sont le plus souvent regroupés par zone à l'intérieur d'un quartier.
Par ailleurs, même si la répartition du territoire semble plutôt homogène, nous nous apercevons que certaines zones sont totalement dépourvues de logement sociaux comme le quartier Saint Donatien.


```{r plot9,fig.width=10}

 knitr::opts_chunk$set(echo = FALSE, message = FALSE,warning = FALSE)

 m <- leaflet(points2017) %>%
   addTiles() %>%
   setView(lng = nantesLong, lat = nantesLat, zoom = 12)  %>%
   addMarkers(lng = ~longitudes, lat = ~latitudes)
 m
```

Intéressons-nous à présent à la qualité des logements sociaux au niveau isolation thermique. Le DPE est l’un des dispositifs du Plan Climat mis en place par l’Etat français pour diminuer nos émissions de CO2 d’ici 2050. Il est obligatoire dans le cadre d'une vente ou d'une location et est valable 10 ans si aucuns travaux d'amélioration énergétique n'ont été réalisés.

En résumé, il permet de classer un logement (à la manière d'un appareil électrique) selon qu'il sera gourmand en énergie ou non. Les notes attribuées vont de A à G, A étant attribué aux logements les mieux isolés et donc les moins énergivores.

Il a été décidé volontairement de vulgariser la qualité du logement social en définissant 3 familles de logements :
- un logement bien isolé appartiendra aux catégories A ou B du DPE,
- un logement moyennement isolé appartiendra aux catégorie C ou D du DPE,
- pour finir, un logement mal isolé répondra aux dernières tranches du DPE à savoir E, F ou G.


<div>
<img src="https://www.ecologique-solidaire.gouv.fr/sites/default/files/styles/standard/public/%C3%89tiquette%20%C3%A9nergie%20-%20DPE.png?itok=CkVXz4EY" width=20%  align="center" />
</div>

On note la proportion de la qualité des logements sociaux au niveau de leur isolation. A Nantes, la grande majorité des logements sont moyennement bien isolés puisque 79,7% des logements sont moyennement bien isolés en 2018.


```{r plotpie,fig.width=10} 
 p <- plot_ly() %>%
   add_pie(points2016, labels = names(table_ener2016), values = table_ener2016, type = 'pie', marker = list(colors = colors, line = list(color = 'rgb(8,48,107)', width = 3)), domain = list(x = c(0, 0.3), y = c(0, 1))) %>%
   add_pie(points2017, labels = names(table_ener2017), values = table_ener2017, type = 'pie', marker = list(colors = colors, line = list(color = 'rgb(8,48,107)', width = 3)), domain = list(x = c(0.35, 0.65), y = c(0, 1))) %>%
   add_pie(points2018, labels = names(table_ener2018), values = table_ener2018, type = 'pie', marker = list(colors = colors, line = list(color = 'rgb(8,48,107)', width = 3)), domain = list(x = c(0.7, 1), y = c(0, 1)))%>%
  layout(title = "Evolution de l'état du logement de 2016 à 2018", showlegend = T,
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))
 p
```


On s'apperçoit sur la carte suivante, que les logements sociaux les moins bien isolés (cat E, F, G) se retrouvent le plus souvent dans des quartiers populaires (Malakoff, Dervallières) et des quartiers anciens.


```{r plot8,fig.width=10}
 
 knitr::opts_chunk$set(echo = FALSE, message = FALSE,warning = FALSE)
 
 hlmMalIso <- points %>% filter(DPEGrad == 'Mal isolé')
 
 m <- leaflet(hlmMalIso) %>%
   addTiles() %>%
   setView(lng = nantesLong, lat = nantesLat, zoom = 14)  %>%
   addMarkers(lng = ~longitudes, lat = ~latitudes)
 m
```


Pour conclure, cette étude nous a permis d’apprendre de multiples faits. Notamment que Reims est la ville de France ayant le plus de logements sociaux par habitants. Nantes est une ville en plein essor et voit son parc social augmenter de façon considérable, etc.

Mais surtout, lors de ce projet, nous avons pu mettre en pratique les connaissances acquises durant l’UE de Datavisualisation, notamment les cours sur « Les données spatiales avec R » et « Création de rapport avec R ». Mais aussi d’autres cours qui nous ont aidé que se soit dans le fond ou dans la forme du rapport, ainsi que notre expérience professionnelle. Cependant, cela ne nous a pas empêché de rencontrer des difficultés.

Le principal problème que nous ayons rencontré est la distance. Comme nous avions chacun notre propre environnement de travail, nous nous échangions régulièrement nos avancements. Et lorsque nous récupérions les développements de notre collègue, temps en temps certains scripts ne fonctionnait pas alors qu’il fonctionnait sur son environnement d’origine. Cela nous a fait perdre du temps car nous devions les débugger afin de reprendre notre travail. Ces problèmes étaient dû à des différences de paramétrages entre nos environnements. Ce projet nous a fait comprendre l’importance de l’utilisation des outils de gestion de version afin de pallier ce type de problème, en utilisant GitHub par exemple.

Pour finir sur une note plus positive, le fait de nous forcer à rendre un rapport dynamique a été une force de motivation et d’inspiration car nous avons découvert un nouveau langage, le html.